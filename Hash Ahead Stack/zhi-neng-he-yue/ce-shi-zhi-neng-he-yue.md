# 测试智能合约

智能合约的高价值以及不可变的性质，无一例外证明了测试智能合约代码的重要性。减少合约中的漏洞、错误，对该合约的开发者而言更是重中之重。

#### 为什么要测试智能合约

1.智能合约是高价值的

智能合约通常处理高价值金融资产，尤其是在去中心化金融等行业，以及诸如非同质化代币等有价值的项目。 因此，智能合约中的小漏洞可能而且通常会给用户带来巨大的、不可挽回的损失。 然而，综合测试可以暴露智能合约代码中的错误并降低部署前的安全风险。

2.智能合约是不可变的

HAH虚拟机 (EVMC) 中部署的智能合约默认是不可变的。 虽然传统开发者可能习惯于在发布后修复软件错误，但智能合约一旦在区块链上运行，HAH开发就几乎没有修补安全漏洞的空间。

虽然智能合约存在可升级性机制，例如代理模式，但这些可能难以实施。 除了降低不可变性和引入复杂性之外，升级通常还需要复杂的治理流程。 在大多数情况下，升级应被视为最后的手段，除非必要，否则应避免。 在预发布阶段检测智能合约中的潜在漏洞和缺陷可减少对逻辑升级的需求。

#### 测试与形式化验证

虽然测试有助于确认合约返回某些数据输入的预期结果，但它不能最终证明测试期间未使用的输入也是如此。 测试智能合约不能保证“功能正确性”，这意味着它不能表明程序的行为符合所有输入值和条件集的要求。

因此，我们鼓励开发者将形式化验证纳入他们评估智能合约正确性的方法中。 形式化验证使用形式化方法 — 用于指定和验证软件的严格数学方法。

形式化验证被认为对智能合约很重要，因为它可以帮助开发者从形式上测试与智能合约相关的假设。 方法是创建描述智能合约属性的形式化规范并验证智能合约的形式化模型是否与规范匹配。 这种方法增加了对智能合约将仅执行其业务逻辑中定义的功能而不执行其他任何功能的信心。

#### 自动化测试

自动化测试涉及使用自动化工具对智能合约进行脚本测试。 该技术依赖于可以执行重复测试以发现智能合约缺陷的自动化软件。 与手动分析相比，自动化测试效率高，使用的资源更少，并且覆盖率更高。自动化测试工具也可以配置测试数据，允许它们将预测的行为与实际结果进行比较。

#### 功能测试

功能测试验证智能合约的功能，并确保代码中的每个功能都按预期工作。 功能测试需要了解你的智能合约在特定条件下的行为方式。

然后，你可以通过使用选定值运行计算并将返回的输出与预期输出进行比较来测试每个函数。 功能测试涵盖三种方法：单元测试、集成测试和系统测试。

#### 单元测试

单元测试需要单独测试智能合约各个组件，确保其正确性。

单元测试简单、快速运行，并且可以清楚地了解测试失败时出了什么问题。 单元测试对于智能合约开发至关重要，尤其是当您需要向代码添加新逻辑时。 你可以验证每个函数的行为并确认它按预期执行。 运行单元测试通常需要创建断言 — 简单、非正式的声明，指定智能合约的要求。 然后可以使用单元测试来测试每个断言，看看它在执行时是否成立。

与合约有关的断言的例子包括：

* 只有管理员才能暂停合约
* 非管理员无权铸造新的代币
* 合约在出错时将会还原

#### 集成测试

在测试层级中，集成测试的层级高于单元测试。 在集成测试中，会一起测试智能合约的独立组件们。这种方法检测由合约的不同组件之间或跨多个合约的交互引起的错误。

如果你有一个具有多个功能的复杂合约或一个与其他合约交互的合约，你应该使用此方法。 集成测试有助于确保继承和依赖注入之类的功能能够正确工作。

#### 系统测试

系统测试是智能合约功能测试的最后阶段。 系统将智能合约作为一个完全集成的产品进行评估，以查看其是否按照技术要求中的规定执行。

你可以将此阶段视为从用户的角度检查智能合约的端到端流程。 对智能合约执行系统测试的一个好方法是将其部署在类似生产的环境中，例如测试网或开发网络。

在这里，最终用户可以进行试运行并报告合约业务逻辑和整体功能的任何问题。 系统测试很重要，因为一旦合约部署到主HAH虚拟机环境中，你就无法更改代码。
